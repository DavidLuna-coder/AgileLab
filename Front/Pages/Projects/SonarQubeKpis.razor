@using Front.ApiClient.Interfaces
@using Front.Components
@using Shared.Constants
@using Shared.DTOs.Projects.Metrics
@inject IProjectsApi ProjectsApi

<MudGrid>
	<!-- 1. Bugs, Code Smells y vulnerabilidades -->

	<MudItem xs="12" md="3">
		<KpiCard Title="Líneas de código" Value=@kpis.NCLoc IsLoading=isLoading Icon="@Icons.Material.Filled.Code"></KpiCard>
	</MudItem>
	<MudItem xs="12" md="3">
		<KpiCard Title="Vulnerabilidades" Value=@kpis.Vulnerabilities IsLoading=isLoading Icon="@Icons.Material.Filled.Security"></KpiCard>
	</MudItem>
	<MudItem xs="12" md="3">
		<KpiCard Title="Bugs" Value=@kpis.Bugs IsLoading=isLoading Icon="@Icons.Material.Filled.BugReport"></KpiCard>
	</MudItem>
	<MudItem xs="12" md="3">
		<KpiCard Title="Code Smells" Value=@kpis.Smells IsLoading=isLoading Icon="@Icons.Material.Filled.Build"></KpiCard>
	</MudItem>

	<!-- 3. Cobertura Meter un gauge -->
	<MudItem xs="12" md="4">
		<MudCard Style="height:100%">
			<MudCardHeader><MudText Typo="Typo.subtitle1">Cobertura</MudText></MudCardHeader>
			<MudCardContent class="d-flex justify-center">
				<MudStack AlignItems="AlignItems.Center" Justify="Justify.Center">
					<MudChart ChartType="ChartType.Donut"
							  InputData="[73, 27]"
							  InputLabels="@(["Cubierto", "No cubierto"])"
							  Width="100%" />
				</MudStack>
			</MudCardContent>
		</MudCard>
	</MudItem>

	<!-- 4. Ficheros más afectados -->
	<MudItem xs="12" md="8">
		<MudCard>
			<MudCardHeader><MudText Typo="Typo.subtitle1">Ficheros con más problemas</MudText></MudCardHeader>
			<MudCardContent>
				<MudChart Width="100%" ChartType="ChartType.Bar" XAxisLabels="@(["Program.cs", "Bloater.cs", "Strategy.cs", "Foo.cs", "Bar.cs"])" ChartSeries="chartSeries" />
			</MudCardContent>
		</MudCard>
	</MudItem>

	<!-- Ficheros con más líneas de código -->
	<MudItem xs="12" md="6">
		<MudCard>
			<MudCardHeader><MudText Typo="Typo.subtitle1">Complejidad Ciclomática</MudText></MudCardHeader>
			<MudCardContent>

			</MudCardContent>
		</MudCard>
	</MudItem>
	<MudItem xs="12" md="6">
		<MudCard>
			<MudCardHeader><MudText Typo="Typo.subtitle1">Líneas de Código (Ncloc)</MudText></MudCardHeader>
			<MudCardContent>

			</MudCardContent>
		</MudCard>
	</MudItem>

	<!-- 7. Último Análisis -->
	<MudItem xs="12">
		<MudCard>
			<MudCardHeader>
				<MudText Typo="Typo.body2">
					Último análisis: <MudText Inline="true" Color="Color.Primary">2025-05-10</MudText>
				</MudText>
			</MudCardHeader>
			<MudCardContent>
				<MudText Typo="Typo.caption">“Build #42 – Análisis maestro”</MudText>
			</MudCardContent>
		</MudCard>
	</MudItem>
</MudGrid>

@code {
	[Parameter]
	public string ProjectId { get; set; }

	public Guid projectId { get => new Guid(ProjectId); }
	private List<ChartSeries> chartSeries;
	private ProjectMetricsDto projectMetrics;
	private SummaryKpi kpis = new();
	private bool isLoading = true;
	protected override void OnInitialized()
	{
		chartSeries = new()
		{
			new(){ Name = "LOC", Data = [31,45,21,11,34] },
			new(){ Name = "Seguridad", Data = [2,1,5,9,51] },
			new(){ Name = "Fiabilidad", Data = [12,61,52,9,1] },
			new(){ Name = "Mantenibilidad", Data = [20,32,5,9,10] }
		};
		base.OnInitialized();
	}

	protected override async Task OnInitializedAsync()
	{
		projectMetrics = await ProjectsApi.GetProjectMetrics(projectId);

		kpis = new()
		{
			NCLoc = int.Parse(projectMetrics.Measures.First(p => p.Metric == SonarMetricKeys.Ncloc).Value),
			Vulnerabilities = int.Parse(projectMetrics.Measures.First(p => p.Metric == SonarMetricKeys.Vulnerabilities).Value),
			Bugs = int.Parse(projectMetrics.Measures.First(p => p.Metric == SonarMetricKeys.Bugs).Value),
			Smells = int.Parse(projectMetrics.Measures.First(p => p.Metric == SonarMetricKeys.CodeSmells).Value),
		};
		isLoading = false;

	}

	class SummaryKpi()
	{
		public int NCLoc { get; set; }
		public int Vulnerabilities { get; set; }
		public int Bugs { get; set; }
		public int Smells { get; set; }
	}
}