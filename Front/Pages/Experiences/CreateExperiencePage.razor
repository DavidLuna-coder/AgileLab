@inject IGoRaceExperiencesApi ExperiencesApi
@page "/experiences/create"
@using Front.ApiClient.Interfaces.GoRaceExperiences
@using Front.Components
@using Front.Helpers
@using Shared.DTOs.Pagination
@using Shared.DTOs.Projects
@inject NavigationManager NavigationManager
@inject IProjectsApi ProjectApi
<PageTitle>Crear experiencia</PageTitle>

<Section Title="Crear experiencia">
	<MudForm @ref="_form" Model="_createExperience">
		<MudStack>
			<MudTextField T="string" @bind-Value="_createExperience.Name" Label="Nombre" Required="true" />
			<MudTextField T="string" @bind-Value="_createExperience.Description" Label="Descripción" />
			<MudTextField T="string" @bind-Value="_createExperience.Token" Label="Token" />
			<MudSelect T="string" @bind-Value="_createExperience.ExperienceType" Label="Tipo" Required="true">
				<MudSelectItem Value="@GoRaceExperienceTypes.Project">Proyecto</MudSelectItem>
				<MudSelectItem Value="@GoRaceExperienceTypes.Platform">Plataforma</MudSelectItem>
			</MudSelect>
			@if (_createExperience.ExperienceType == GoRaceExperienceTypes.Project)
			{
				<MudAutocomplete @bind-Value=selectedProject Required Label="Proyecto" ShowProgressIndicator DebounceInterval=200 T="FilteredProjectDto" ToStringFunc=@((p) => p.Name) SearchFunc="SearchProjects">

				</MudAutocomplete>
				//Selector de proyecto con buscador por nomb</ItemSelectedTemplate>re
			}
			else if (_createExperience.ExperienceType == GoRaceExperienceTypes.Platform)
			{
				//Tabla de proyectos con selección múltiple
			}

			<MudStack Row Justify="Justify.FlexEnd">
				<MudButton OnClick="Cancel" Variant="Variant.Filled">Cancelar</MudButton>
				<MudButton OnClick="SaveExperience" Variant=Variant.Filled Color="Color.Primary">Guardar</MudButton>
			</MudStack>
		</MudStack>
	</MudForm>
</Section>

@code {

	MudForm _form;
	CreateGoRaceExperienceDto _createExperience = new();
	FilteredProjectDto? selectedProject;
	async Task SaveExperience()
	{
		await _form.Validate();
		if (!_form.IsValid)
		{
			return;
		}

		_createExperience.ProjectId = selectedProject?.Id;
		await ExperiencesApi.Create(_createExperience);
		NavigationManager.NavigateTo<ExperiencesPage>();
	}

	void Cancel() => NavigationManager.NavigateTo<ExperiencesPage>();

	async Task<IEnumerable<FilteredProjectDto>> SearchProjects(string s, CancellationToken token)
	{
		if (token.IsCancellationRequested)
		{
			return Enumerable.Empty<FilteredProjectDto>();
		}
		FilteredPaginatedRequestDto<ProjectQueryParameters> request = new()
		{
			Filters = new() { Name = s ?? string.Empty },
			Page = 0,
			PageSize = 10
		};
		var result = await ProjectApi.GetProjects(request);
		return result.Items;
	}
}